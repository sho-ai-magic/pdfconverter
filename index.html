<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Converter Tool</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- PDF.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    <!-- JSZip -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <!-- FileSaver.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <!-- PptxGenJS -->
    <script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>
    <!-- GIF.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gif.js/0.2.0/gif.js"></script>
    <!-- SortableJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <!-- jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Tesseract.js (For OCR) -->
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    
    <style>
        .drag-active {
            border-color: #3b82f6;
            background-color: #eff6ff;
        }
        body {
            font-family: 'Noto Sans JP', sans-serif;
            overflow-x: hidden;
        }
        .custom-scrollbar::-webkit-scrollbar {
            height: 8px;
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        .page-card {
            transition: all 0.2s;
        }
        .page-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .sortable-ghost {
            opacity: 0.5;
            background: #e0e7ff;
        }
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.75);
        }
        canvas {
            touch-action: none;
        }
        /* Dropdown Menu Animation */
        .menu-enter {
            opacity: 0;
            transform: scale(0.95) translateY(-10px);
        }
        .menu-enter-active {
            opacity: 1;
            transform: scale(1) translateY(0);
            transition: opacity 0.2s ease-out, transform 0.2s ease-out;
        }
        /* Toast Animation */
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .toast-enter {
            animation: slideInRight 0.3s ease-out forwards;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen text-gray-800">

    <div class="container mx-auto px-4 py-6 max-w-6xl">
        <!-- Header -->
        <header class="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-8 pb-6 border-b border-gray-200 gap-4 relative">
            <div class="w-full sm:w-auto">
                <h1 class="text-xl sm:text-2xl font-bold text-indigo-600 flex items-center gap-2">
                    <span class="text-2xl sm:text-3xl">üìÑ</span> PDFÂ§âÊèõ„ÉªÁ∑®ÈõÜ„ÉÑ„Éº„É´
                </h1>
                <p class="text-[10px] sm:text-xs text-gray-500 mt-1 font-medium">‰∏¶„ÅπÊõø„Åà„ÉªÂõûËª¢„ÉªÈªíÂ°ó„Çä„ÉªOCR„ÉªÂêÑÁ®ÆÂ§âÊèõ</p>
            </div>

            <div class="relative w-full sm:w-auto flex justify-end">
                <button id="menu-btn" onclick="toggleMenu()" class="flex items-center justify-center gap-2 bg-indigo-600 hover:bg-indigo-700 text-white px-5 sm:px-6 py-2.5 sm:py-3 rounded-full shadow-lg hover:shadow-xl transition-all active:scale-95 font-bold z-50 relative whitespace-nowrap text-sm sm:text-base">
                    <span class="text-lg sm:text-xl">üì•</span>
                    <span>‰øùÂ≠ò„ÉªÊõ∏„ÅçÂá∫„Åó</span>
                    <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </button>

                <div id="download-menu" class="hidden absolute right-0 top-full mt-3 w-72 sm:w-80 bg-white rounded-2xl shadow-2xl border border-gray-100 p-4 z-40 origin-top-right transform transition-all duration-200">
                    <div class="flex justify-between items-center mb-3 pb-2 border-b border-gray-100">
                        <span class="text-[10px] font-bold text-gray-400 uppercase tracking-wider">Download Options</span>
                        <button onclick="toggleMenu()" class="text-gray-400 hover:text-gray-600 text-xl">&times;</button>
                    </div>

                    <div class="space-y-3 max-h-[60vh] overflow-y-auto custom-scrollbar pr-1">
                        <!-- 1. PDF -->
                        <div class="bg-gray-50 rounded-xl p-3 border border-gray-100 hover:border-red-200 hover:bg-red-50/50 transition-colors">
                            <div class="flex items-center gap-3 mb-2">
                                <div class="w-8 h-8 rounded-full bg-white text-red-500 flex items-center justify-center text-lg shadow-sm">üìÑ</div>
                                <div>
                                    <h4 class="font-bold text-xs text-gray-800">PDFÂÜçÊßãÁØâ</h4>
                                    <p class="text-[9px] text-gray-500">Á∑®ÈõÜÂÜÖÂÆπ„ÇíÂèçÊò†„Åó„Å¶‰øùÂ≠ò</p>
                                </div>
                            </div>
                            <button onclick="convertPDF('pdf')" class="w-full py-1.5 bg-white border border-gray-200 text-red-600 text-[11px] font-bold rounded-lg hover:bg-red-500 hover:text-white transition-colors shadow-sm">
                                PDF„Å®„Åó„Å¶‰øùÂ≠ò
                            </button>
                        </div>

                        <!-- 2. PNG -->
                        <div class="bg-gray-50 rounded-xl p-3 border border-gray-100 hover:border-indigo-200 hover:bg-indigo-50/50 transition-colors">
                            <div class="flex items-center gap-3 mb-2">
                                <div class="w-8 h-8 rounded-full bg-white text-indigo-500 flex items-center justify-center text-lg shadow-sm">üñºÔ∏è</div>
                                <div>
                                    <h4 class="font-bold text-xs text-gray-800">ÁîªÂÉè (PNG)</h4>
                                    <p class="text-[9px] text-gray-500">ÂÖ®„Éö„Éº„Ç∏„ÇíZIP„Åß‰øùÂ≠ò</p>
                                </div>
                            </div>
                            <button onclick="convertPDF('png')" class="w-full py-1.5 bg-white border border-gray-200 text-indigo-600 text-[11px] font-bold rounded-lg hover:bg-indigo-500 hover:text-white transition-colors shadow-sm">
                                ZIP„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ
                            </button>
                        </div>

                        <!-- 3. PPTX -->
                        <div class="bg-gray-50 rounded-xl p-3 border border-gray-100 hover:border-orange-200 hover:bg-orange-50/50 transition-colors">
                            <div class="flex items-center gap-3 mb-2">
                                <div class="w-8 h-8 rounded-full bg-white text-orange-500 flex items-center justify-center text-lg shadow-sm">üìä</div>
                                <div>
                                    <h4 class="font-bold text-xs text-gray-800">PowerPoint</h4>
                                    <p class="text-[9px] text-gray-500">„Çπ„É©„Ç§„Éâ„Å®„Åó„Å¶‰øùÂ≠ò</p>
                                </div>
                            </div>
                            <div class="bg-white rounded border border-gray-100 p-2 mb-2 text-[10px] space-y-1.5">
                                <div class="flex items-center justify-between">
                                    <label class="flex items-center cursor-pointer">
                                        <input type="checkbox" id="pptx-hide-logo" class="rounded text-orange-500 focus:ring-orange-500 w-3 h-3 border-gray-300">
                                        <span class="ml-1.5 text-gray-600 font-medium">NotebookLM„É≠„Ç¥„Éû„Çπ„ÇØ</span>
                                    </label>
                                    <input type="color" id="pptx-mask-color" value="#FFFFFF" class="w-5 h-5 rounded cursor-pointer border border-gray-300 p-0 bg-white">
                                </div>
                                <div class="flex items-center border-t border-gray-100 pt-1.5">
                                    <label class="flex items-center cursor-pointer">
                                        <input type="checkbox" id="pptx-speaker-notes" class="rounded text-orange-500 focus:ring-orange-500 w-3 h-3 border-gray-300">
                                        <span class="ml-1.5 text-gray-600 font-medium">„ÉÜ„Ç≠„Çπ„Éà„Çí„Éé„Éº„Éà„Å∏</span>
                                    </label>
                                </div>
                            </div>
                            <button onclick="convertPDF('pptx')" class="w-full py-1.5 bg-white border border-gray-200 text-orange-600 text-[11px] font-bold rounded-lg hover:bg-orange-500 hover:text-white transition-colors shadow-sm">
                                PPTX„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ
                            </button>
                        </div>

                        <!-- 4. GIF -->
                        <div class="bg-gray-50 rounded-xl p-3 border border-gray-100 hover:border-green-200 hover:bg-green-50/50 transition-colors">
                            <div class="flex items-center gap-3 mb-2">
                                <div class="w-8 h-8 rounded-full bg-white text-green-500 flex items-center justify-center text-lg shadow-sm">üé¨</div>
                                <div>
                                    <h4 class="font-bold text-xs text-gray-800">GIF„Ç¢„Éã„É°</h4>
                                    <p class="text-[9px] text-gray-500">„Éë„É©„Éë„É©Êº´ÁîªÈ¢®</p>
                                </div>
                            </div>
                            <div class="bg-white rounded border border-gray-100 p-1.5 mb-2 text-[10px] flex items-center justify-center gap-2">
                                <span class="text-gray-600 font-medium">ÈñìÈöî:</span>
                                <input type="number" id="gif-interval" value="1.5" min="0.1" step="0.1" class="w-10 py-0.5 text-center border border-gray-300 rounded text-gray-700">
                                <span class="text-gray-500">Áßí</span>
                            </div>
                            <button onclick="convertPDF('gif')" class="w-full py-1.5 bg-white border border-gray-200 text-green-600 text-[11px] font-bold rounded-lg hover:bg-green-500 hover:text-white transition-colors shadow-sm">
                                GIFÁîüÊàê
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Drop Zone -->
        <div id="drop-zone" class="bg-white border-2 border-dashed border-gray-300 rounded-xl p-8 sm:p-12 text-center cursor-pointer transition-colors duration-200 hover:border-indigo-400 mb-8 shadow-sm">
            <div class="flex flex-col items-center justify-center space-y-4">
                <svg class="w-12 h-12 sm:w-16 sm:h-16 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                </svg>
                <div class="text-base sm:text-lg font-medium text-gray-700 leading-tight">PDF„Éï„Ç°„Ç§„É´„Çí„Åì„Åì„Å´„Éâ„É©„ÉÉ„Ç∞ÔºÜ„Éâ„É≠„ÉÉ„Éó</div>
                <div class="text-sm text-gray-500">„Åæ„Åü„ÅØ</div>
                <label for="file-input" class="bg-indigo-600 text-white px-6 py-3 rounded-lg hover:bg-indigo-700 transition cursor-pointer shadow-md flex items-center space-x-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                    <span>„Éï„Ç°„Ç§„É´„ÇíÈÅ∏Êäû</span>
                </label>
                
                <div class="mt-6 pt-4 border-t border-gray-100 w-full max-w-sm mx-auto">
                    <label class="flex items-center justify-center cursor-pointer bg-gray-50 px-4 py-3 rounded-xl border border-gray-200 hover:bg-gray-100 transition shadow-inner group">
                        <input type="checkbox" id="enable-ocr" class="w-5 h-5 text-indigo-600 rounded focus:ring-indigo-500 border-gray-300">
                        <div class="ml-3 text-left">
                            <span class="block text-sm text-gray-800 font-bold group-hover:text-indigo-600">OCRÊñáÂ≠óË™çË≠ò„ÇíÊúâÂäπ„Å´„Åô„Çã</span>
                            <span class="block text-[10px] text-gray-400 leading-none mt-0.5 font-medium">‚Äª„Çπ„Ç≠„É£„É≥„Éá„Éº„ÇøÁ≠â„Åã„Çâ„ÉÜ„Ç≠„Çπ„Éà„ÇíÊäΩÂá∫</span>
                        </div>
                    </label>
                </div>
                <input type="file" id="file-input" accept="application/pdf,.pdf" class="hidden">
            </div>
        </div>

        <!-- Editor Area (Hidden by default) -->
        <div id="editor-area" class="hidden animate-in fade-in duration-500">
            <!-- File Info Bar -->
            <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 mb-6 flex flex-col sm:flex-row sm:items-center justify-between gap-3">
                <div class="flex items-center space-x-3 overflow-hidden">
                    <div class="bg-indigo-100 p-2 rounded-lg flex-shrink-0">
                        <svg class="w-5 h-5 text-indigo-500" fill="currentColor" viewBox="0 0 20 20"><path d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z"/></svg>
                    </div>
                    <div class="min-w-0">
                        <h3 id="file-name" class="font-bold text-gray-800 truncate text-sm">filename.pdf</h3>
                        <p id="page-count-display" class="text-[10px] text-gray-400 uppercase tracking-tighter font-black">Analysis Complete</p>
                    </div>
                </div>
                <button id="reset-btn" class="w-full sm:w-auto text-gray-500 hover:text-red-600 text-xs font-bold px-4 py-2 hover:bg-red-50 rounded-lg transition border border-gray-200 sm:border-transparent">
                    Âà•„ÅÆ„Éï„Ç°„Ç§„É´„Çí„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ
                </button>
            </div>

            <!-- Page Management -->
            <div class="mb-8">
                <div class="flex flex-col sm:flex-row sm:items-end justify-between mb-4 px-1 gap-4">
                    <div>
                        <h2 class="text-lg font-bold text-gray-800">„Éö„Éº„Ç∏„ÅÆÁ∑®ÈõÜ</h2>
                        <p class="text-xs text-gray-500 mt-0.5">‰∏¶„ÅπÊõø„Åà„ÉªÂõûËª¢„ÉªÈªíÂ°ó„Çä„ÅåÂèØËÉΩ„Åß„Åô„ÄÇ</p>
                    </div>
                    <div class="flex items-center justify-between sm:justify-end gap-3 w-full sm:w-auto">
                        <span id="selected-count" class="text-xs font-bold text-indigo-600 bg-indigo-50 px-3 py-1.5 rounded-full border border-indigo-100"></span>
                        <div class="flex gap-2">
                            <button onclick="copyAllText()" class="text-[11px] bg-white hover:bg-gray-50 text-gray-700 px-3 py-1.5 rounded-lg border border-gray-200 shadow-sm transition flex items-center gap-1 font-bold">
                                <span>üìã</span> „Ç≥„Éî„Éº
                            </button>
                            <button onclick="downloadAllText()" class="text-[11px] bg-white hover:bg-gray-50 text-gray-700 px-3 py-1.5 rounded-lg border border-gray-200 shadow-sm transition flex items-center gap-1 font-bold">
                                <span>üíæ</span> ‰øùÂ≠ò
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- PREVIEW GRID: Changed grid-cols-2 to grid-cols-1 for mobile -->
                <div id="preview-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 sm:gap-6 bg-gray-100/50 p-4 sm:p-6 rounded-2xl border border-gray-200 min-h-[200px]">
                    <!-- Preview cards will be injected here -->
                </div>
            </div>
        </div>

        <!-- Notification Toast Area -->
        <div id="notification-area" class="fixed bottom-6 right-6 z-[60] flex flex-col gap-3 pointer-events-none max-w-[90vw]"></div>

        <!-- Masking Modal -->
        <div id="mask-modal" class="hidden fixed inset-0 z-50 overflow-hidden modal-overlay flex flex-col items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl max-h-[95vh] flex flex-col animate-in zoom-in duration-300">
                <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-white rounded-t-2xl">
                    <h3 class="font-bold text-gray-800">ÈªíÂ°ó„ÇäÁ∑®ÈõÜ</h3>
                    <button onclick="closeMaskModal()" class="text-gray-400 hover:text-gray-700 text-3xl font-light">&times;</button>
                </div>
                <div class="flex-grow overflow-auto p-4 bg-gray-900/5 flex items-center justify-center relative">
                    <div class="relative shadow-2xl border border-white">
                        <canvas id="mask-canvas" class="cursor-crosshair bg-white max-w-full"></canvas>
                    </div>
                </div>
                <div class="p-4 border-t border-gray-100 bg-gray-50 rounded-b-2xl flex flex-col sm:flex-row gap-4 sm:items-center justify-between">
                    <p class="text-xs text-gray-500">„Éâ„É©„ÉÉ„Ç∞„Åó„Å¶Â°ó„Çä„Å§„Å∂„Åó„ÄÇ‰øùÂ≠ò„Åô„Çã„Å®Êàª„Åõ„Åæ„Åõ„Çì„ÄÇ</p>
                    <div class="flex gap-3">
                        <button onclick="closeMaskModal()" class="flex-1 sm:flex-none px-6 py-2 text-sm text-gray-600 hover:bg-gray-200 rounded-xl transition font-medium">„Ç≠„É£„É≥„Çª„É´</button>
                        <button onclick="applyMask()" class="flex-1 sm:flex-none px-8 py-2 bg-indigo-600 text-white font-bold rounded-xl hover:bg-indigo-700 transition shadow-lg">ÈÅ©Áî®</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Global Progress Overlay -->
        <div id="progress-container" class="hidden fixed inset-0 bg-gray-900/80 backdrop-blur-sm flex items-center justify-center z-[100] px-4">
            <div class="bg-white p-8 rounded-3xl shadow-2xl max-w-sm w-full text-center">
                <div class="relative w-16 h-16 mx-auto mb-6">
                    <div class="absolute inset-0 rounded-full border-4 border-indigo-100"></div>
                    <div id="progress-spinner" class="absolute inset-0 rounded-full border-4 border-indigo-600 border-t-transparent animate-spin"></div>
                </div>
                <h3 class="text-lg font-bold text-gray-900 mb-1 leading-tight">„Éï„Ç°„Ç§„É´„ÇíÂá¶ÁêÜ‰∏≠</h3>
                <p id="progress-text" class="text-sm text-gray-500 mb-6 font-medium">Ê∫ñÂÇô‰∏≠...</p>
                <div class="w-full bg-gray-100 rounded-full h-2 overflow-hidden">
                    <div id="progress-bar" class="bg-indigo-600 h-full rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
            </div>
        </div>

        <div id="canvas-container" class="hidden"></div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const { jsPDF } = window.jspdf;
            let currentPDF = null;
            let currentFile = null;
            let sortableInstance = null;
            const pageEdits = {};

            // Masking Vars
            let isDrawing = false;
            let startX = 0, startY = 0;
            let currentEditPageIndex = null;
            const maskCanvas = document.getElementById('mask-canvas');
            const ctx = maskCanvas.getContext('2d');
            let tempImage = null;

            // OCR Worker
            let ocrWorker = null;

            // --- Notifications ---
            window.showNotification = function(message, type = 'info') {
                const container = document.getElementById('notification-area');
                const el = document.createElement('div');
                const bg = type === 'success' ? 'bg-green-600' : type === 'warning' ? 'bg-orange-500' : type === 'error' ? 'bg-red-600' : 'bg-gray-800';
                
                el.className = `${bg} text-white px-5 py-3.5 rounded-2xl shadow-2xl flex items-center justify-between min-w-[280px] toast-enter pointer-events-auto border border-white/10`;
                el.innerHTML = `
                    <div class="flex items-center gap-3">
                        <span class="text-xl font-bold">${type === 'success' ? '‚ú®' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è'}</span>
                        <span class="text-sm font-bold leading-tight">${message}</span>
                    </div>
                `;
                container.appendChild(el);
                setTimeout(() => {
                    el.style.transition = 'all 0.5s ease-in';
                    el.style.opacity = '0';
                    el.style.transform = 'translateX(50px)';
                    setTimeout(() => el.remove(), 500);
                }, 4000);
            }

            // --- Menu Logic ---
            window.toggleMenu = function() {
                const menu = document.getElementById('download-menu');
                menu.classList.toggle('hidden');
                if(!menu.classList.contains('hidden')) {
                    menu.classList.add('menu-enter');
                    setTimeout(() => menu.classList.add('menu-enter-active'), 10);
                }
            }

            document.addEventListener('click', (e) => {
                const menu = document.getElementById('download-menu');
                const btn = document.getElementById('menu-btn');
                if (menu && !menu.classList.contains('hidden') && !menu.contains(e.target) && !btn.contains(e.target)) {
                    menu.classList.add('hidden');
                }
            });

            // --- File Handling ---
            const dropZone = document.getElementById('drop-zone');
            const fileInput = document.getElementById('file-input');
            dropZone.onclick = (e) => { if(!e.target.closest('label')) fileInput.click(); };
            
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(ev => {
                dropZone.addEventListener(ev, e => { e.preventDefault(); e.stopPropagation(); });
            });
            dropZone.addEventListener('dragover', () => dropZone.classList.add('drag-active'));
            dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-active'));
            dropZone.addEventListener('drop', e => {
                dropZone.classList.remove('drag-active');
                if (e.dataTransfer.files[0]?.type === 'application/pdf') loadPDF(e.dataTransfer.files[0]);
            });
            fileInput.onchange = e => { if(e.target.files[0]) loadPDF(e.target.files[0]); };

            document.getElementById('reset-btn').onclick = () => location.reload();

            // --- Core PDF Logic ---
            window.loadPDF = async function(file) {
                try {
                    showProgress(0, 'PDF„ÇíË™≠„ÅøËæº„Çì„Åß„ÅÑ„Åæ„Åô...');
                    const buffer = await file.arrayBuffer();
                    currentPDF = await pdfjsLib.getDocument({ data: buffer }).promise;
                    currentFile = file;
                    document.getElementById('file-name').textContent = file.name;
                    document.getElementById('drop-zone').classList.add('hidden');
                    document.getElementById('editor-area').classList.remove('hidden');
                    await renderPreviews();
                    hideProgress();
                } catch (e) { hideProgress(); alert('„Ç®„É©„Éº: ' + e.message); }
            };

            async function renderPreviews() {
                const container = document.getElementById('preview-grid');
                container.innerHTML = '';
                const total = currentPDF.numPages;
                const enableOCR = document.getElementById('enable-ocr').checked;

                for (let i = 1; i <= total; i++) {
                    if (!pageEdits[i]) pageEdits[i] = { rotation: 0, customImage: null, text: "" };
                    updateProgress((i / total) * 100, `Ëß£Êûê‰∏≠... ${i}/${total}`);

                    const canvas = await renderPageToCanvas(i, 0.4, 0);
                    const thumb = canvas.toDataURL('image/jpeg', 0.8);

                    let text = "";
                    try {
                        const page = await currentPDF.getPage(i);
                        const content = await page.getTextContent();
                        text = content.items.map(it => it.str).join(" ");
                        if (enableOCR && text.replace(/\s/g, '').length < 10) {
                            if (!ocrWorker) ocrWorker = await Tesseract.createWorker('jpn+eng');
                            const ocrCanvas = await renderPageToCanvas(i, 2.0, 0);
                            const res = await ocrWorker.recognize(ocrCanvas);
                            text = res.data.text;
                        }
                    } catch (err) { text = "(„ÉÜ„Ç≠„Çπ„ÉàÊäΩÂá∫„Ç®„É©„Éº)"; }

                    pageEdits[i].text = text.trim();
                    container.appendChild(createCard(i, thumb, pageEdits[i].text));
                }

                if(sortableInstance) sortableInstance.destroy();
                sortableInstance = new Sortable(container, {
                    animation: 200, ghostClass: 'sortable-ghost', handle: '.drag-handle', onEnd: updateCount
                });
                updateCount();
            }

            function createCard(idx, img, txt) {
                const div = document.createElement('div');
                div.className = 'page-card bg-white p-4 rounded-3xl shadow-sm border border-gray-100 flex flex-col relative group';
                div.dataset.pageIndex = idx;
                div.id = `card-${idx}`;
                // Changed h-44 to sm:h-44 and added h-64 for mobile to fill space better in 1-column layout
                div.innerHTML = `
                    <div class="drag-handle relative w-full mb-4 cursor-grab active:cursor-grabbing rounded-2xl overflow-hidden bg-gray-50 border border-gray-100 shadow-inner">
                        <img src="${img}" id="img-${idx}" class="w-full h-64 sm:h-44 object-contain transition-transform">
                        <div class="absolute inset-0 bg-black/0 group-hover:bg-black/5 transition-colors"></div>
                        <div class="absolute bottom-2 right-2 bg-indigo-600/10 text-indigo-600 px-2 py-0.5 rounded-lg text-[10px] font-black tracking-widest backdrop-blur-sm border border-indigo-100/50">PAGE ${idx}</div>
                    </div>
                    <div class="flex items-center justify-between mb-3 px-1">
                        <div class="flex items-center gap-1.5">
                            <span class="w-2 h-2 rounded-full bg-indigo-500"></span>
                            <span class="text-[11px] font-black text-gray-400 uppercase tracking-tighter">Tools</span>
                        </div>
                        <div class="flex gap-1.5">
                            <button onclick="rotatePage(${idx})" class="p-2 bg-gray-50 hover:bg-gray-100 rounded-xl text-sm transition" title="ÂõûËª¢">üîÑ</button>
                            <button onclick="openMaskModal(${idx})" class="p-2 bg-gray-50 hover:bg-gray-100 rounded-xl text-sm transition" title="ÈªíÂ°ó„Çä">‚úèÔ∏è</button>
                        </div>
                    </div>
                    <textarea class="w-full h-28 sm:h-20 text-[11px] border border-gray-100 rounded-2xl p-3 focus:ring-4 focus:ring-indigo-50 outline-none bg-gray-50/50 transition-all leading-relaxed font-medium" placeholder="„ÉÜ„Ç≠„Çπ„Éà..." onchange="pageEdits[${idx}].text=this.value">${txt}</textarea>
                    <button onclick="this.parentElement.remove(); updateCount();" class="absolute -top-3 -right-3 bg-white text-red-500 rounded-full w-9 h-9 flex items-center justify-center shadow-xl hover:bg-red-50 border border-gray-100 opacity-100 sm:opacity-0 sm:group-hover:opacity-100 transition-all font-black">&times;</button>
                `;
                return div;
            }

            // --- Actions ---
            window.rotatePage = async function(idx) {
                const state = pageEdits[idx];
                if(state.customImage) {
                    const img = new Image(); img.src = state.customImage;
                    await new Promise(r => img.onload = r);
                    const can = document.createElement('canvas'); can.width = img.height; can.height = img.width;
                    const c = can.getContext('2d');
                    c.translate(can.width/2, can.height/2); c.rotate(Math.PI/2);
                    c.drawImage(img, -img.width/2, -img.height/2);
                    state.customImage = can.toDataURL();
                    document.getElementById(`img-${idx}`).src = state.customImage;
                } else {
                    state.rotation = (state.rotation + 90) % 360;
                    document.getElementById(`img-${idx}`).style.transform = `rotate(${state.rotation}deg)`;
                }
            }

            window.openMaskModal = async function(idx) {
                currentEditPageIndex = idx;
                showProgress(0, 'È´òÁîªË≥™Âåñ„Åó„Å¶Ê∫ñÂÇô‰∏≠...');
                const state = pageEdits[idx];
                const can = await renderPageToCanvas(idx, 2.0, state.rotation);
                tempImage = new Image();
                tempImage.onload = () => {
                    maskCanvas.width = tempImage.width; maskCanvas.height = tempImage.height;
                    ctx.drawImage(tempImage, 0, 0);
                    document.getElementById('mask-modal').classList.remove('hidden');
                    hideProgress();
                };
                tempImage.src = state.customImage || can.toDataURL();
            }

            window.closeMaskModal = () => document.getElementById('mask-modal').classList.add('hidden');
            maskCanvas.onmousedown = e => {
                isDrawing = true;
                const r = maskCanvas.getBoundingClientRect();
                const sx = maskCanvas.width / r.width, sy = maskCanvas.height / r.height;
                startX = (e.clientX - r.left) * sx; startY = (e.clientY - r.top) * sy;
            };
            maskCanvas.onmousemove = e => {
                if(!isDrawing) return;
                const r = maskCanvas.getBoundingClientRect();
                const sx = maskCanvas.width / r.width, sy = maskCanvas.height / r.height;
                const cx = (e.clientX - r.left) * sx, cy = (e.clientY - r.top) * sy;
                ctx.drawImage(tempImage, 0, 0);
                ctx.fillStyle = 'rgba(0,0,0,0.5)';
                ctx.fillRect(startX, startY, cx - startX, cy - startY);
            };
            maskCanvas.onmouseup = e => {
                if(!isDrawing) return; isDrawing = false;
                const r = maskCanvas.getBoundingClientRect();
                const sx = maskCanvas.width / r.width, sy = maskCanvas.height / r.height;
                ctx.fillStyle = '#000000';
                ctx.fillRect(startX, startY, ((e.clientX - r.left) * sx) - startX, ((e.clientY - r.top) * sy) - startY);
                tempImage.src = maskCanvas.toDataURL();
            };
            window.applyMask = () => {
                const state = pageEdits[currentEditPageIndex];
                state.customImage = maskCanvas.toDataURL(); state.rotation = 0;
                document.getElementById(`img-${currentEditPageIndex}`).src = state.customImage;
                document.getElementById(`img-${currentEditPageIndex}`).style.transform = 'none';
                closeMaskModal();
            };

            window.convertPDF = async function(type) {
                const cards = Array.from(document.querySelectorAll('.page-card'));
                if(!cards.length) return;
                document.getElementById('download-menu').classList.add('hidden');
                showProgress(10, 'Âá¶ÁêÜ‰∏≠...');
                try {
                    const pages = [];
                    for(let i=0; i<cards.length; i++){
                        const origIdx = parseInt(cards[i].dataset.pageIndex);
                        const state = pageEdits[origIdx];
                        updateProgress(10 + (i/cards.length)*50, `Âä†Â∑•‰∏≠... ${i+1}/${cards.length}`);
                        let data, w, h, ow, oh;
                        if(state.customImage){
                            data = state.customImage;
                            const img = new Image(); img.src = data; await new Promise(r => img.onload = r);
                            w = img.width; h = img.height; ow = w; oh = h;
                        } else {
                            const can = await renderPageToCanvas(origIdx, 2.0, state.rotation);
                            data = can.toDataURL('image/png');
                            w = can.width; h = can.height; ow = can.dataset.ow; oh = can.dataset.oh;
                        }
                        pages.push({ data, w, h, ow, oh, text: state.text });
                    }
                    if(type === 'pdf') await buildPdf(pages);
                    else if(type === 'png') await buildZip(pages);
                    else if(type === 'pptx') await buildPptx(pages);
                    else if(type === 'gif') await buildGif(pages);
                } catch(e) { alert(e.message); }
                hideProgress();
            };

            // --- Exporters ---
            async function buildPdf(pages) {
                const doc = new jsPDF({ orientation: pages[0].w > pages[0].h ? 'l' : 'p', unit: 'px', format: [pages[0].w, pages[0].h] });
                pages.forEach((p, i) => {
                    if(i > 0) doc.addPage([p.w, p.h], p.w > p.h ? 'l' : 'p');
                    doc.addImage(p.data, 'PNG', 0, 0, p.w, p.h);
                });
                doc.save(`${currentFile.name.replace('.pdf', '')}_edited.pdf`);
                showNotification('PDF„ÅÆ‰øùÂ≠òÂÆå‰∫Ü', 'success');
            }
            async function buildZip(pages) {
                const zip = new JSZip();
                pages.forEach((p, i) => zip.file(`p${i+1}.png`, p.data.split(',')[1], {base64: true}));
                const blob = await zip.generateAsync({type: 'blob'});
                saveAs(blob, `${currentFile.name.replace('.pdf', '')}_images.zip`);
                showNotification('ZIP„ÅÆ‰øùÂ≠òÂÆå‰∫Ü', 'success');
            }
            async function buildPptx(pages) {
                const pres = new PptxGenJS();
                const hideLogo = document.getElementById('pptx-hide-logo').checked;
                const color = document.getElementById('pptx-mask-color').value.replace('#','');
                const notes = document.getElementById('pptx-speaker-notes').checked;
                pres.defineLayout({ name:'PDF', width: pages[0].ow/72, height: pages[0].oh/72 });
                pres.layout = 'PDF';
                pages.forEach(p => {
                    const s = pres.addSlide();
                    s.addImage({ data: p.data, x: 0, y: 0, w: '100%', h: '100%' });
                    if(hideLogo) s.addShape(pres.ShapeType.rect, { x: (p.ow/72)*0.9, y: (p.oh/72)*0.95, w: (p.ow/72)*0.1, h: (p.oh/72)*0.05, fill: {color} });
                    if(notes && p.text) s.addNotes(p.text);
                });
                await pres.writeFile({ fileName: `${currentFile.name.replace('.pdf','')}.pptx` });
                showNotification('PPTX„ÅÆ‰øùÂ≠òÂÆå‰∫Ü', 'success');
            }
            async function buildGif(pages) {
                const delay = (parseFloat(document.getElementById('gif-interval').value) || 1.5) * 1000;
                const workerUrl = URL.createObjectURL(await (await fetch('https://cdnjs.cloudflare.com/ajax/libs/gif.js/0.2.0/gif.worker.js')).blob());
                const gif = new GIF({ workers: 2, quality: 10, width: pages[0].w, height: pages[0].h, workerScript: workerUrl });
                const imgs = await Promise.all(pages.map(p => { const i = new Image(); i.src = p.data; return new Promise(r => i.onload = () => r(i)); }));
                imgs.forEach(i => gif.addFrame(i, {delay}));
                gif.on('finished', b => { saveAs(b, 'output.gif'); showNotification('GIF‰øùÂ≠òÂÆå‰∫Ü', 'success'); });
                gif.render();
            }

            // --- Helpers ---
            async function renderPageToCanvas(num, scale, rot) {
                const p = await currentPDF.getPage(num);
                const v = p.getViewport({ scale, rotation: rot });
                const vOrig = p.getViewport({ scale: 1.0, rotation: rot });
                const can = document.createElement('canvas');
                can.width = v.width; can.height = v.height;
                can.dataset.ow = vOrig.width; can.dataset.oh = vOrig.height;
                await p.render({ canvasContext: can.getContext('2d'), viewport: v }).promise;
                return can;
            }
            window.copyAllText = () => {
                const txt = Array.from(document.querySelectorAll('.page-card textarea')).map((t, i) => `[P${i+1}]\n${t.value}`).join('\n\n');
                navigator.clipboard.writeText(txt).then(() => showNotification('ÂÖ®„Ç≥„Éî„ÉºÂÆå‰∫Ü', 'success'));
            };
            window.downloadAllText = () => {
                const txt = Array.from(document.querySelectorAll('.page-card textarea')).map((t, i) => `[P${i+1}]\n${t.value}`).join('\n\n');
                saveAs(new Blob([txt], {type:'text/plain'}), 'extracted.txt');
            };
            function updateCount() {
                const c = document.getElementById('preview-grid').children.length;
                document.getElementById('selected-count').textContent = `${c} „Éö„Éº„Ç∏`;
            }
            function showProgress(val, txt) {
                document.getElementById('progress-container').classList.remove('hidden');
                updateProgress(val, txt);
            }
            function updateProgress(val, txt) {
                document.getElementById('progress-bar').style.width = val + '%';
                if(txt) document.getElementById('progress-text').textContent = txt;
            }
            function hideProgress() {
                setTimeout(() => document.getElementById('progress-container').classList.add('hidden'), 500);
            }
        });
    </script>
</body>
</html>
